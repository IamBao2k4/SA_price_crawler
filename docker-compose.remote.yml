services:
  # Binance Crawler Producer
  crawler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: binance_crawler
    environment:
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      KAFKA_TOPIC_PREFIX: ${KAFKA_TOPIC_PREFIX:-binance.klines}
      MONGODB_URI: ${MONGODB_URI}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-binance}
      TZ: ${TZ:-Asia/Ho_Chi_Minh}
      PYTHONUNBUFFERED: 1
      ACTIVE_INTERVALS: ${ACTIVE_INTERVALS:-1m,5m,15m,1h,4h,1d}
    volumes:
      - ./symbols_top20.txt:/app/symbols_top20.txt:ro
      - ./logs:/app/logs
    restart: unless-stopped
    command: sh -c "sleep 10 && python main_producer.py"
    network_mode: host  # Sử dụng host network để kết nối remote

  # Kafka Consumer -> MongoDB Writer
  consumer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: binance_consumer
    environment:
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      KAFKA_TOPIC_PREFIX: ${KAFKA_TOPIC_PREFIX:-binance.klines}
      KAFKA_GROUP_ID: ${KAFKA_GROUP_ID:-binance-consumer-group}
      MONGODB_URI: ${MONGODB_URI}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-binance}
      TZ: ${TZ:-Asia/Ho_Chi_Minh}
      PYTHONUNBUFFERED: 1
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    command: sh -c "sleep 5 && python main_consumer.py"
    network_mode: host
