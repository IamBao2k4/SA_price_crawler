services:
  # Zookeeper - Lightweight
  zookeeper:
    image: wurstmeister/zookeeper:latest
    container_name: binance_zookeeper
    ports:
      - "2181:2181"
    networks:
      - binance-network

  # Kafka - Lightweight
  kafka:
    image: wurstmeister/kafka:latest
    container_name: binance_kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092,PLAINTEXT_HOST://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    networks:
      - binance-network

  # MongoDB - Lightweight
  mongodb:
    image: mongo:7.0-jammy
    container_name: binance_mongodb
    ports:
      - "27022:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: binance
    volumes:
      - mongodb_data:/data/db
    networks:
      - binance-network
    command: mongod --quiet --logpath /dev/null

  # Kafka UI - Lightweight
  # kafka-ui:
  #   image: provectuslabs/kafka-ui:v0.7.2
  #   container_name: binance_kafka_ui
  #   depends_on:
  #     - kafka
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     KAFKA_CLUSTERS_0_NAME: binance
  #     KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
  #     DYNAMIC_CONFIG_ENABLED: 'true'
  #   networks:
  #     - binance-network

  # Binance Crawler Producer
  crawler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: binance_crawler
    depends_on:
      - kafka
      - mongodb
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_TOPIC_PREFIX: binance.klines
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/
      MONGODB_DATABASE: binance
      TZ: Asia/Ho_Chi_Minh
      PYTHONUNBUFFERED: 1
    volumes:
      - ./symbols_top20.txt:/app/symbols_top20.txt:ro
      - ./logs:/app/logs
    networks:
      - binance-network
    restart: unless-stopped
    command: sh -c "sleep 45 && python main_producer.py"

  # Kafka Consumer -> MongoDB Writer
  consumer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: binance_consumer
    depends_on:
      - kafka
      - mongodb
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_TOPIC_PREFIX: binance.klines
      KAFKA_GROUP_ID: binance-consumer-group
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/
      MONGODB_DATABASE: binance
      TZ: Asia/Ho_Chi_Minh
      PYTHONUNBUFFERED: 1
    volumes:
      - ./logs:/app/logs
    networks:
      - binance-network
    restart: unless-stopped
    command: sh -c "sleep 20 && python main_consumer.py"

networks:
  binance-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
